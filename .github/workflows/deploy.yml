name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Debug SSH Information
        run: |
          echo "ðŸ” Debugging SSH Connection"
          echo "Host: ${{ secrets.EC2_HOST }}"
          echo "Username: ${{ secrets.EC2_USERNAME }}"
          echo "SSH Key Check: ${{ secrets.EC2_SSH_KEY != '' && 'Present' || 'Missing' }}"
      
      - name: Setup SSH Directory
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ls -la ~/.ssh/deploy_key
          
      - name: Validate SSH Key Format
        run: |
          echo "ðŸ“ Validating SSH key format..."
          if ! grep -q "BEGIN RSA PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "âŒ SSH key is missing BEGIN header"
            exit 1
          fi
          if ! grep -q "END RSA PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "âŒ SSH key is missing END footer"
            exit 1
          fi
          echo "âœ… SSH key format validation passed"
      
      - name: Test SSH Connection
        id: ssh_test
        continue-on-error: true
        run: |
          ssh -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} 'echo "SSH Connection Successful"'
      
      - name: Check SSH Connection Result
        if: steps.ssh_test.outcome == 'failure'
        run: |
          echo "âŒ SSH Connection Failed"
          echo "Debug Information:"
          echo "Key Permissions:"
          ls -la ~/.ssh/deploy_key
          echo "Key Format:"
          ssh-keygen -l -f ~/.ssh/deploy_key || echo "Invalid key format"
          exit 1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            echo "âš ï¸ No package-lock.json found, installing without lockfile..."
            npm install
          fi
          
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          debug: true
          script_stop: true
          # Add timeout for long-running deployments
          command_timeout: "30m"
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."
            
            # Update package lists and install dependencies
            echo "ðŸ“¦ Updating system packages..."
            sudo apt-get update && sudo apt-get install -y curl git build-essential python3 || {
              echo "âŒ Failed to install system packages"
              exit 1
            }
            
            # Install Node.js and npm
            echo "ðŸ“¦ Installing Node.js and npm..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - && \
            sudo apt-get install -y nodejs || {
              echo "âŒ Failed to install Node.js"
              exit 1
            }
            
            # Install additional build tools
            echo "ðŸ“¦ Installing additional build tools..."
            sudo apt-get install -y gcc g++ make || {
              echo "âŒ Failed to install build tools"
              exit 1
            }
            
            # Install PM2 globally
            echo "ðŸ“¦ Installing PM2..."
            sudo npm install -g pm2 || {
              echo "âŒ Failed to install PM2"
              exit 1
            }
            
            # Create deployment directory
            echo "ðŸ“‚ Creating deployment directory..."
            sudo mkdir -p /var/www/strapi-cms
            sudo chown -R $USER:$USER /var/www/strapi-cms || {
              echo "âŒ Failed to set directory permissions"
              exit 1
            }
            
            # Clone or update repository
            if [ ! -d "/var/www/strapi-cms/.git" ]; then
              echo "ðŸ“¥ Cloning repository..."
              git clone https://github.com/Last-Hash/lasthash-strapi-cms.git /var/www/strapi-cms || {
                echo "âŒ Failed to clone repository"
                exit 1
              }
            fi
            
            cd /var/www/strapi-cms || {
              echo "âŒ Failed to change directory"
              exit 1
            }
            echo "ðŸ“‚ Current directory: $(pwd)"
            
            # Pull latest changes
            echo "ðŸ“¦ Running git pull..."
            git pull origin main || {
              echo "âŒ Failed to pull latest changes"
              exit 1
            }
            
            # Clean install dependencies with swap space to prevent OOM
            echo "ðŸ“¥ Installing dependencies..."
            rm -rf node_modules
            rm -f package-lock.json # Remove lockfile to avoid conflicts
            
            # Setup swap space to prevent OOM errors
            echo "ðŸ’¾ Setting up swap space..."
            if [ ! -f /swapfile ]; then
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo "/swapfile swap swap defaults 0 0" | sudo tee -a /etc/fstab
              echo "âœ… Swap space created"
            else
              echo "âœ… Swap space already exists"
            fi
            sudo swapon --show
            
            # Install dependencies with smaller chunks
            echo "ðŸ“¦ Installing dependencies in chunks..."
            export NODE_OPTIONS="--max_old_space_size=2048"
            npm install --no-fund --no-audit --prefer-offline --production=false
            
            # Setup environment file with correct values
            echo "ðŸ“ Setting up environment file..."
            echo "HOST=0.0.0.0" > .env
            echo "PORT=1337" >> .env
            echo "APP_KEYS=toBeModified1,toBeModified2,toBeModified3,toBeModified4" >> .env
            echo "API_TOKEN_SALT=b6c3c3f1d8e70c8529f775881b761f70" >> .env
            echo "ADMIN_JWT_SECRET=787ea12b6507b7cdac4fdd7af0ede5a4" >> .env
            echo "TRANSFER_TOKEN_SALT=8c9b95d2e1f1d4a2b84a8e4c984c6f32" >> .env
            echo "JWT_SECRET=3fb45e852d67f1c4a88e2c52d0b79f49" >> .env
            echo "DATABASE_CLIENT=sqlite" >> .env
            echo "DATABASE_FILENAME=.tmp/data.db" >> .env
            
            # Build application with debugging
            echo "ðŸ—ï¸ Building application..."
            NODE_ENV=production npm run build -- --debug || {
              echo "âŒ Failed to build application"
              echo "Trying alternative build approach..."
              # Try alternative build approach if direct build fails
              NODE_ENV=production npm run build:admin || {
                echo "âŒ Failed to build admin"
                exit 1
              }
              NODE_ENV=production npm run build:backend || {
                echo "âŒ Failed to build backend"
                exit 1
              }
            }
            
            # Setup and start PM2
            echo "ðŸ”„ Configuring PM2..."
            pm2 delete strapi 2>/dev/null || true
            pm2 start npm --name "strapi" -- start || {
              echo "âŒ Failed to start PM2 process"
              exit 1
            }
            pm2 save || {
              echo "âŒ Failed to save PM2 configuration"
              exit 1
            }
            
            # Setup PM2 startup
            echo "âš™ï¸ Setting up PM2 startup..."
            sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u $USER --hp /home/$USER || {
              echo "âŒ Failed to setup PM2 startup"
              exit 1
            }
            
            # Install and configure Nginx
            echo "ðŸŒ Setting up Nginx..."
            sudo apt-get install -y nginx || {
              echo "âŒ Failed to install Nginx"
              exit 1
            }
            
            # Create Nginx configuration file for Strapi
            echo "ðŸ“ Creating Nginx configuration..."
            sudo bash -c 'cat > /etc/nginx/sites-available/strapi << "EOF"
server {
    listen 80;
    server_name crm.lasthash.com;

    location / {
        proxy_pass http://localhost:1337;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 90;
        client_max_body_size 100M;
    }
}
EOF'
            
            # Remove default site if exists and enable Strapi site
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo ln -sf /etc/nginx/sites-available/strapi /etc/nginx/sites-enabled/ || {
              echo "âŒ Failed to enable Nginx site"
              exit 1
            }
            
            # Test and restart Nginx
            sudo nginx -t && sudo systemctl restart nginx || {
              echo "âŒ Failed to configure Nginx"
              exit 1
            }
            
            # Install Certbot for SSL
            echo "ðŸ”’ Setting up SSL with Let's Encrypt..."
            sudo apt-get install -y certbot python3-certbot-nginx || {
              echo "âŒ Failed to install Certbot"
              exit 1
            }
            
            # Request SSL certificate with automatic Nginx configuration
            echo "ðŸ”’ Requesting SSL certificate..."
            sudo certbot --nginx -d crm.lasthash.com --non-interactive --agree-tos --email shiv@srapsware.com || {
              echo "âš ï¸ SSL certificate setup failed, but continuing deployment"
            }
            
            # Ensure Certbot renewal cron job is setup
            echo "ðŸ”„ Setting up certificate auto-renewal..."
            sudo systemctl enable certbot.timer
            sudo systemctl start certbot.timer
            
            echo "âœ… Deployment complete!"